---
name: codeQL-task
on:
  push:
    branches:
      - "develop"
      - "main"

jobs:
  codeql-job:
    name: codeql-job
    runs-on: ubuntu-latest
    steps:
      - name: Cdeckout repository
        uses: actions/checkout@v3

      - name: Setup CodeQL
        run: |
          wget https://github.com/github/codeql-cli-binaries/releases/download/v2.3.4/codeql-osx64.zip
          unzip codeql-osx64.zip
          rm -f codeql-osx64.zip
          git clone -b v1.26.0 https://github.com/github/codeql.git ql
      
      - name: Setup Bazel
        run: |
          # sudo add-apt-repository ppa:webupd8team/java
          # sudo apt-get update
          # sudo apt-get install oracle-java8-installer
          # sudo apt-get install pkg-config zip g++ zlib1g-dev unzip
          # wget https://github.com/bazelbuild/bazel/releases/download/0.2.0/bazel-0.2.0-installer-linux-x86_64.sh
          # chmod +x bazel-0.2.0-installer-linux-x86_64.sh
          # ./bazel-version-installer-os.sh --user
          # export PATH="$PATH:$HOME/bin"
          sudo apt install apt-transport-https curl gnupg
          curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor > bazel.gpg
          sudo mv bazel.gpg /etc/apt/trusted.gpg.d/
          echo "deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list
          sudo apt update && sudo apt install bazel
          sudo apt update && sudo apt full-upgrade
          sudo apt install bazel-1.0.0
          ls -al

      - name: Run codeQL-task
        run: |
          mkdir -p  codeql_work
          codeql/codeql database create codeql_work/codeql-database --language=cpp --command='bazel build //main:hello-world'
          echo "success"

      - name: Clean workspace
        if: ${{ always() }}
        run: |
          chmod +w ${{github.workspace}} -Rf
          rm -rf ${{github.workspace}}/*
